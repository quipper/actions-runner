name: build

on:
  pull_request:
  push:
    branches:
      - main
    tags:
      - '*'

jobs:
  build:
    uses: ./.github/workflows/reusable--build.yaml
    permissions:
      contents: read
      packages: write

  build-ubuntu20:
    uses: ./.github/workflows/reusable--build.yaml
    permissions:
      contents: read
      packages: write
    with:
      file: Dockerfile.ubuntu20
      flavor: suffix=-ubuntu20

  e2e-test:
    needs:
      - build
      - build-ubuntu20
    uses: ./.github/workflows/reusable--e2e-test.yaml
    secrets: inherit
    permissions:
      contents: read
      actions: write
    with:
      runner-image-uri: ${{ needs.build.outputs.image-uri }}
      runner-ubuntu20-image-uri: ${{ needs.build-ubuntu20.outputs.image-uri }}

  finally-cancel-workflow-run:
    needs: e2e-test
    if: failure()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      actions: write
    steps:
      - uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            await github.rest.actions.cancelWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            })
