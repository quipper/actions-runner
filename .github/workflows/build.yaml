name: build

on:
  pull_request:
  push:
    branches:
      - main
    tags:
      - "*"

jobs:
  build:
    uses: ./.github/workflows/reusable--build.yaml
    permissions:
      contents: read
      packages: write

  e2e-test:
    needs:
      - build
    uses: ./.github/workflows/reusable--e2e-test.yaml
    secrets: inherit
    permissions:
      contents: read
      actions: write
    with:
      runner-image-uri: ${{ needs.build.outputs.image-uri }}
      runner-name: e2e-${{ github.event.pull_request.number || github.ref_name }}
      expected-image-os: ubuntu22

  build-ubuntu20:
    uses: ./.github/workflows/reusable--build.yaml
    permissions:
      contents: read
      packages: write
    with:
      file: Dockerfile.ubuntu20
      flavor: suffix=-ubuntu20

  sleep-before-e2e-test-ubuntu20:
    needs: build-ubuntu20
    runs-on: ubuntu-latest
    steps:
      - run: sleep 60

  e2e-test-ubuntu20:
    needs:
      - build-ubuntu20
      - sleep-before-e2e-test-ubuntu20
    uses: ./.github/workflows/reusable--e2e-test.yaml
    secrets: inherit
    permissions:
      contents: read
      actions: write
    with:
      runner-image-uri: ${{ needs.build-ubuntu20.outputs.image-uri }}
      runner-name: e2e-${{ github.event.pull_request.number || github.ref_name }}-ubuntu20
      expected-image-os: ubuntu20

  finally-cancel-workflow-run:
    needs:
      - e2e-test
      - e2e-test-ubuntu20
    if: failure()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      actions: write
    steps:
      - uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            await github.rest.actions.cancelWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            })
